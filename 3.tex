\chapter{Реализация модуля графического интерфейса}
\section[{\textls[-30]{Описание реализованного модуля графического интерфейса}}]{Описание реализованного модуля графического интерфейса}
Реализованный модуль графического интерфейса состоит из~двух частей: серверной и~клиентской. Клиентская часть разбита на~множество наборов виджетов, которые распределены по~узлам гетерогенной сети системы управления технологическим оборудованием. 

Расположение частей модуля пользовательского графического интерфейса на аппаратных ресурсах приведено на UML диаграмме развертывания~(\autoref{fig:deploy}). При этом в качестве примера рассматривается разрабатываемое модульное оборудование Adapteq~\cite{adapteq} с установленной интеллектуальной лазерной головкой.

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.95\textwidth]{deploy.eps}
    \caption[{\textls[30]{UML диаграмма развертывания модуля графического интерфейса}}]
            {\textls[-30]{UML диаграмма развертывания модуля графического интерфейса}}
    \label{fig:deploy}
\end{figure} 

\textls[-30]{Основой клиентской части служит оболочка, в~которой реализованы окно авторизации пользователя, меню с~наборами виджетов, упорядоченными по~категориям, и~редактируемое рабочее пространство. Данная оболочка по~умолчанию предлагает заранее организованное рабочее пространство, однако оставляет пользователю возможность изменять его по~своему желанию\,(например, удалять или добавлять виджеты, масштабировать их~и~т.\,д.).}

\textls[20]{Оболочка представляет собой html файл с~соответствующими \mbox{css файлами}, где описан её внешний вид, и~js файлы, где приведена логика отвечающая за~работу меню, обработку жестов при сенсорном управлении и~другие вещи важные для корректной работы графического интерфейса~(\autoref{fig:wrap}).}

\begin{figure}[h!]
    \centering
    \includegraphics[width=1\textwidth]{wrap.png}
    \caption[Внешний вид оболочки]
            {Внешний вид оболочки}
    \label{fig:wrap}
\end{figure} 
Виджеты встраиваются в~клиентскую оболочку с~использованием фреймов. Использование фреймов позволяет встраивать в~базовый документ любые независимые фрагменты, при этом отображая их~в~заданной области определенного размера. Виджет, также как и~оболочка, является html файлом с~набором связанных с~ним css и~js файлов. Внутри js файлов кроме логики работы графической части содержатся обработчики, позволяющие устанавливать соединение с~сервером и~обмениваться с~ним данными по~протоколу WebSocket~(\autoref{fig:client}). 

\begin{figure}[h!]
    \centering
    \includegraphics[width=1\textwidth]{websock.png}
    \caption[Внутренняя структура виджета]
            {Внутренняя структура виджета}
    \label{fig:client}
\end{figure} 

Серверная часть модуля графического интерфейса представлена HTTP и WebSocket сервером. Через HTTP-соединение пользователю передается оболочка графического интерфейса, а~через WebSocket-соединение происходит асинхронное взаимодействие с~виджетами. После авторизации пользователя обмен идет через безопасное HTTPS-~и~WSS-соединение с~шифрованием. Сервер реализован на языке Go c~использованием фреймворка Revel~(\autoref{fig:server}).

Сервер открывает для <<прослушивания>> набор веб-сокетов. Количество открытых сокетов соответствует количеству наборов виджетов с~одной стороны, а~с~другой стороны открывает сокеты для взаимодействия в~распределенной сети системы ЧПУ.
\begin{figure}[h!]
    \centering
    \includegraphics[width=1\textwidth]{server.png}
    \caption[Внутренняя структура сервера]
            {Внутренняя структура сервера}
    \label{fig:server}
\end{figure} 
\section[{\textls[-30]{Описание взаимодействия реализованного модуля графического} интерфейса}]{Описание взаимодействия реализованного модуля графического интерфейса}
Для взаимодействия серверной части модуля с~клиентской частью, т.\,е.~виджетами пользовательского графического интерфейса, используется протокол {\it WebSocket}. Данный протокол является полнодуплексным\footnote{Означает, что передача и~отправка могут осуществляться одновременно.} и~асинхронным. Это позволяет осуществлять взаимодействие клиента и~системы ЧПУ в~условиях близких к~условиям реального времени, так называемое <<мягкое реальное время>>. Более того, протокол WebSocket имеет версию, поддерживающую шифрование WSS. На~текущий момент все популярные браузеры полностью поддерживают этот протокол.

Для реализации взаимодействия используется WebSocket API, доступное в~JavaScript. Для установки соединения с~сервером применяется <<рукопожатие>>~--~процедура, при которой клиент и~сервер посылают друг другу запросы на~соединение~(\autoref{fig:hs}).

Однако для унификации протокола во~всей системе управления технологическим оборудованием связь осуществляется поверх протокола WebSocket на~основе библиотеки {\it nanomsg}. \textls[-20]{При этом используется тип взаимодействия <<подписка-издатель>>. Для этого на~клиентской части достаточно добавить параметр при~вызове конструктора WebSocket.}

Разработанный модуль работает на~двух этапах: инициализации и~рабочем этапе. При инициализации осуществляется опрос модулей системы ЧПУ. В~сеть посылается широковещательный запрос, и~те~модули, которые могут на~него ответить, посылают на~сервер модуля графического интерфейса наборы виджетов и~метаданные~(\autoref{fig:seq}). Во~время же~рабочего этапа осуществляется обмен полезными данными (командами, данными модулей, управляющими программами и~т.\,д.).

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.8\textwidth]{hs.eps}
    \caption[Диаграмма последовательности рукопожатия WebSocket]
            {Диаграмма последовательности рукопожатия WebSocket}
    \label{fig:hs}
\end{figure} 

\begin{figure}[h!]
    \centering
    \includegraphics[width=1\textwidth]{seq.eps}
    \caption[{\textls[30]{Диаграмма последовательности модуля графического интерфейса}}]
            {Диаграмма последовательности модуля графического интерфейса}
    \label{fig:seq}
\end{figure} 
\section{Состав технических средств}
Cерверная часть программного обеспечения была развернута на аппаратной платформе ODROID~C2. Платформа ODROID C2~--~это 64-битный одноплатный четырехпроцессорный микрокомпьютер с~установленной операционной системой Ubuntu Mate. В составе системы управления ЧПУ данный модуль связывается с остальными модулями через Ethernet, UART и WiFi. Технические характеристики данного микрокомпьютера приведены в~таблице~\ref{tabodroid}.

\begin{table}[!h]
	\centering
	\label{tab}
	\caption{Технические характеристики Odroid-C2.}\label{tabodroid}\vspace{4pt}
	\begin{tabular}{|c|c|}
		\hline
		\textbf{Характеристика} & \textbf{Значение}\\
		\hline
		Процессор& Amlogic ARM Cortex-A53(ARMv8) 1.5ГГц\\
		\hline
		Графический процессор&  Mali-450 GPU\\
		\hline
		Память& 2Гб DDR3 SDRAM\\
		\hline
		Ethernet& Gigabit Ethernet\\
		\hline
		USB& USB 2.0 4 порта\\
		\hline
		Слоты флеш-памяти & UHS-1 SDR50 MicroSD, eMMC5.0 HS400\\
		\hline
		USB OTG&  USB 2.0 OTG 1 порт\\
		\hline
		Ввод/вывод & 40pin GPIOs + 7pin I2S\\
		\hline
		Размер, мм & 85$\times$56$\times$18\\
		\hline
		Вес, г & 40\\
		\hline
	\end{tabular}
\end{table}

\textls[-10]{Для обеспечения доступа к~беспроводной сети, был использован WiFi-адаптер. Как видно из~таблицы~\ref{tabodroid}, микрокомпьютер не~имеет встроенного WiFi-модуля, поэтому был использован внешний адаптер, подключаемый по~USB. Его технические характеристики указаны в~таблице~\ref{tab2}.}

\begin{table}[!h]
	\centering
	\label{tabadapt}
	\caption{Технические характеристики Mediatek Ralink RT5370N2.}\label{tab2}\vspace{4pt}
	\begin{tabular}{|c|c|}
		\hline
		\textbf{Характеристика} & \textbf{Значение}\\
		\hline
		Интерфейс подключения& USB 2.0 \\
		\hline
		Стандарт WiFi& IEEE 802.11 b/g/n\\
		\hline
		Частота& 2.4 ГГц\\
		\hline
		Размер, мм & 22.5$\times$13.8$\times$6.5\\
		\hline
		Вес, г & 3.5\\
		\hline
	\end{tabular}
\end{table}
\section{Выводы к третьей главе}
\begin{enumerate}
\item Поскольку важно, чтобы модуль графического интерфейса работал в режиме <<мягкого реального времени>>, то для увеличения его производительности и скорости работы необходимо использовать компилируемый язык с продвинутой поддержкой асинхронности и многопоточности. Одним из таких языков программирования является язык Go.
\item При организации взаимодействия в~целях обеспечения безопасности важно использовать протоколы, поддерживающие шифрование. Более того, следует стремиться к~унификации протокола во~всей системе управления.
\item Разработанный графический модуль не~предъявляет высокие требования к~аппаратным ресурсам. Поэтому для его размещения достаточно микрокомпьютера, либо обладающего встроенным WiFi-адаптером, либо имеющего интерфейс, через который возможно подсоединить внешний WiFi-адаптер.
\end{enumerate}
