 \def\figureautorefname{рис.}
  \def\equationautorefname{формуле}
\chapter{Пользовательский графический интерфейс систем управления технологическим оборудованием}
\section{Виды пользовательского интерфейса систем управления технологическим оборудованием и~его основные функции}
Любая система управления технологическим оборудованием состоит из трех основных частей:
\begin{itemize}
\item ядро системы управления;
\item программируемый логический контроллер;
\item человеко-машинный интерфейс.
\end{itemize}

Обычно человеко-машинный интерфейс в~технологическом оборудование реализуется двумя способами: {\it аппаратным} и~{\it программным}.

Классическая реализация аппаратной стойки управления включает в~себя множество кнопок, регуляторов и~других физических элементов~(\autoref{fig:fanuc}). При этом все чаще стали получать распространение стойки, которые имеют в~своем составе сенсорные экраны~(\autoref{fig:kse}), позволяющие в~разы сократить количество физических элементов управления, оставив только самые критически важные, например, кнопку аварийного останова.

\begin{figure}[h!]
    \centering
    \includegraphics[width=.9\textwidth]{019_FANUC-0iTD.jpg}
    \caption[Стойка FANUC Series 0i-TD]
            {Стойка FANUC Series 0i-TD}
    \label{fig:fanuc}
\end{figure} 

\begin{figure}[h!]
    \centering
    \includegraphics[width=.7\textwidth]{kse_cnc.jpg}
    \caption[Стойка KSE-TOUCH CNC]
            {Стойка KSE-TOUCH CNC}
    \label{fig:kse}
\end{figure} 

Одним из главных недостатков таких стоек является то, что они располагаются непосредственно рядом с~технологическим оборудованием и~не~обеспечивают возможность удаленного управления. 

Многие производители технологического оборудования, пытаясь решить эту проблему, прилагают программное обеспечение, установив которое на~персональный компьютер, появляется возможность осуществлять удаленное управление. Однако с~таким подходом сопряжен {\it ряд проблем}. 

{\it Во-первых}, обычно поддерживается только ряд известных платформ, что вносит ограничения в~организацию управления оборудованием.

{\it Во-вторых}, технологическое оборудование имеет долгий срок службы, а учитывая скорость развития информационных технологий и~компьютерной техники, такое программное обеспечение придется регулярно обновлять. При этом процесс обновления так или иначе будет требовать определенного набора действий от пользователя, поскольку изменения будут проходить именно на~используемой целевой машине.

{\it В-третьих}, отсутствие мобильности, поскольку оператор все также остается привязан к~определенному рабочему месту.

Вместе с~тем, учитывая тенденции развития современных производственных систем, важно не~только обеспечить удаленное управление, но~и определенный уровень абстракции. Это позволило бы незаметно для нижнего уровня осуществлять управление и~наблюдение как с~помощью оператора, так и~с~использованием другой программной системы более высокого порядка. 

Сейчас \textbf{\textit{ функции пользовательского интерфейса}} обычно подразделяются на~{\it пять групп}~\cite{theory_of_cnc}:
\begin{enumerate}
\item {\it Операционные функции}. Они используются часто и~помогают управлять технологическим оборудованием, а также показывают его состояние. Они занимаются отображением позиции, расстояния, подачи по каждой оси, скорости шпинделя, выполняемого блока программы и~статуса. Кроме того, предусмотрены функции, помогающие работать с~технологическим оборудованием, такие как перемещение в~режимах Jog\footnote{Jog -- режим, который может быть использован для перемещения по заданной оси с~заданной скоростью.} и~MDI\footnote{MDI\,(Manual data input) -- режим ввода команды (например, G-код) для прямого выполнения.}, поиск программ, редактор программ и~управление инструментами.
\item {\it Функции настройки параметров}. В системе ЧПУ имеются различные параметры для внутреннего использования, которые подразделяются на~три вида: 
	\begin{itemize}
	\item  параметры станка, которые используются для настройки станка, сервопривода, смещения инструмента, рабочей 	координаты;
	\item параметры программы, которые должны быть установлены при редактировании программы обработки детали;
	\item параметры настройки, которые используются, чтобы адаптировать машину к~требованиям пользователя.
	\end{itemize}  
Эти функции предоставляют интерфейс для установки, хранения и~поиска параметров.
\item {\it Функции редактирования программы.} Эти функции позволяют редактировать и~модифицировать программу обработки детали, которая представляет собой G-код.
\item {\it Функции контроля и~сигнализации.} Система ЧПУ всегда уведомляет пользователя о состоянии и, при необходимости, запускает на~исполнение важные задачи и~информирует пользователя о результате. Функции сигнализации  оповещают о сигнале тревоги, методе аварийного восстановления~и~т.д.
\item {\it Служебные функции.} Помимо других четырех основных функций, для оказания помощи пользователям предоставляется множество полезных функций. Например, осуществление сетевого взаимодействия и~управление данными пользователя.
\end{enumerate}
%Далее приведен минимальный {\it набор функций}, которые должны выполняться пользовательским графическим интерфейсом системы управления технологическим оборудованием:
%\begin{itemize}
%\item визуализация процесса обработки;
%\item обеспечение управления рабочими органами технологического оборудования;
%\item управление данными системы;
%\item осуществление сетевого взаимодействия;
%\item ввод управляющих программ.
%\end{itemize}

Графический интерфейс в~первую очередь предоставляет широкий набор возможностей по визуализации процесса обработки. Визуализация процесса обработки является важной, поскольку дает возможность пользователю оборудования определить состояние и~этап процесса обработки в~реальном времени. В технологическом оборудовании визуализация обычно осуществляется несколькими способами:
\begin{itemize}
\item Экран, отображающий проделанный путь рабочей головки. Он позволяет визуально оценить получаемый результат. Особенно полезен в~случаях, когда нет возможности осмотра происходящей обработки с~камер или в~реальности, например лазерная обработка или сварка.
\item Экран с~управляющей программой и~выделенной текущей строкой, позволяет ответить на~вопросы: <<какое действие сейчас выполняется?>> и~<<какая часть работ уже выполнена?>>.
\item Набор экранов, отображающих текущие координаты рабочей головки, текущие настройки, инструмент, скорости~и~т.д.
\item Экран видеонаблюдения. Применяется, когда оборудование оснащено камерами, обычно когда нет прямого доступа для наблюдения рабочей области.
\item Экран с~3D-моделью выполняемого процесса в~реальном времени.
\end{itemize}

Из всего вышесказанного следует, что графическая часть пользовательского интерфейса позволяет наиболее полно и~наглядно обеспечивать связь технологического оборудования с~пользователем, используя современные технологии, например, 3D-моделирование и~работу с~видео.
%В контексте современного интеллектуального производства этот набор может быть расширен множеством дополнительных возможностей, например, удаленным сервисным доступом, управлением данными пользователей и~их~правами доступа.

%Одним из очевидных примеров, может быть система мониторинга оборудования. Реализация которой сейчас является сложной и~дорогостоящей задачей. Однако наличие уровня абстракции позволило бы строить систему мониторинга по принципу агрегатора элементов наблюдения (а~не~состояний напрямую) со всего технологического оборудования. Это означает, что для создания системы мониторинга потребовалось бы решить только задачу агрегации и~компановки, не~задумываясь о способах сбора и~отображния данных.

%В качестве еще одного примера, можно привести ситуацию, когда производственный процесс строится по принципу <<переговоров>> участников производственного процесса. Для осуществления такого подхода система управления конкретного технологического оборудования должна быть расширена системой планирования. Одним из вариантов реализации такой системы может быть реализация над модулем пользовательского интерфейса. Это означает, что данная система использовала бы те же самые интерфейсы, которыми пользуется оператор, но~без их~графической составляющей, например интерфейсом загрузки управляющей программы.

\section{Инструменты разработки графического интерфейса}
\section{Структурно-модульный подход к~разработке графического интерфейса}
\section[Способ взаимодействия пользовательского графического интерфейса]{Способ взаимодействия пользовательского графического интерфейса}
Микросервисная архитектура модульной системы управления предполагает применение общего облегченного протокола взаимодействия, позволяющего скрыть особенности реализации модулей. Так как модуль пользовательского графического интерфейса является частью децентрализованной гетерогенной сети, необходимо использовать <<умные>> приемники сообщений и~<<глупые каналы>> передачи данных. Подобное решение дает возможность делать модули системы максимально независимыми и~сфокусированными на~решении одной конкретной задачи.

Очевидно, что при работе в~сетях TCP/IP, наиболее очевидным способом передачи данных являются <<сырые>> сокеты. Через этот программный интерфейс можно передавать байтовый поток данных. Но в~разрабатываемой системе все модули, в~том числе и~модуль пользовательского графического интерфейса, обмениваются уже структурированной информацией. Поэтому более правильным подходом будет использование разновидности пакетной передачи данных. Каждый пакет – есть некоторое сообщение, которое может быть передано от одного модуля к~другому. Получив данное сообщение, принимающий модуль должен подтвердить получение (в случае, если его содержимое ему понятно и~может быть обработано) либо отклонить сообщение.

Легко заметить, что подобные сообщения очень похожи на~те, которые используются в~таких протоколах как XML-RPC, SOAP, BPEL или WSDL, но~с одним важным отличием. Все эти протоколы используются в~крупных промышленных приложениях и~явно не~подходят для встраиваемых систем. А так как модуль графического интерфейса должен осуществлять взаимодействие и~со встраиваемыми системами, то данный недостаток является существенным. Для создания легковесной, открытой и~расширяемой системы управления необходимо минимизировать слой абстракции, максимально используя преимущества низкоуровневых сокетов в~сочетании с~возможностью осуществлять маршрутизацию сообщений. 

Таким образом, наиболее подходящим способом взаимодействиями модулей проектируемой системы числового программного управления являются \textbf{\textit{очереди сообщений}}.

Очередь сообщений является асинхронным протоколом передачи данных, то есть отправитель и~получатель сообщения не~взаимодействуют друг с~другом напрямую, а только через очередь.

Можно выделить следующие \textbf{\textit{основные особенности очередей сообщений}}, которые позволяют сделать вывод о том, что для проектируемой системы управления данный способ передачи данных является наиболее целесообразным:
\begin{itemize}
\item Очереди сообщений позволяют компонентам системы оставаться максимально независимыми друг от друга, исключая возможные взаимные блокировки, когда один из участников взаимодействия вынужден ожидать освобождения сетевых ресурсов, необходимых ему для передачи или приема данных.
\item Очереди сообщений дают возможность экономить вычислительные ресурсы за счет отсутствия необходимости в~сетевых буферах, в~которых хранятся еще не~переданные или еще необработанные данные. По сути, очередь сообщений сама является универсальным сетевым буфером, не~привязанным к~какому-то конкретному узлу или процессу. 
\item Очереди сообщений легко масштабируются как по объему передаваемых данных, так и~по пропускной способности.
\item Очереди сообщений позволяют легко сглаживать пиковые нагрузки, возникающие в~сети. Для проектируемой системы управления это особенно важно, так как в~ней возможно смешение разных типов трафика. В частности, можно выделить как минимум высокоприоритетный трафик (данные от датчиков, команды управления) и~низкоприоритетный трафик (загрузка исходного текста программы управления в~контроллер, передача видео из зоны обработки~и~т.д.).
\item Очереди сообщений позволяют существенно повысить отказоустойчивость системы, ведь сообщения остаются в~очереди и~могут быть обработаны даже в~случае отказа отправившего их~узла. Это можно продемонстрировать на~примере передачи управления управляющей программы для оборудования с~ЧПУ. Управляющая программа создается оператором в~блоке интерфейса, а затем передается в~блок исполнения в~виде потока текстовых команд. Очевидно, что программа будет передана в~виде нескольких сообщений, помещаемых в~очередь, причем на~максимально возможной скорости. Предположим, что какой-то момент блок интерфейса <<зависает>>, данный факт фиксируется сторожевым таймером, который инициирует перезагрузку операционной системы. Однако во время перезагрузки блок исполнения продолжает считывать и~обрабатывать сообщения из очереди, и~для него процесс передачи данных не~прерывается.
\item Очереди сообщений гарантируют доставку сообщения, по крайней мере до тех пор, пока в~сети функционирует хотя бы один узел, который может обработать их.
\item Очереди сообщений не~нарушают порядок передаваемых сообщений. Как правило, сообщения будут получены именно в~том порядке, в~котором они были отправлены.
\end{itemize}

%Добавить сюда еще что-нибудь

\section{Отображение модуля на~RAMI 4.0 }
Индустрия 4.0 включает в~себя множество аспектов, и~для того, чтобы определить общее виденье этих аспектов и~их связь, была создана архитектурная модель RAMI 4.0 (\autoref{fig:rami}). Данная модель является трехмерной и~по трём осям отображает предметную область с~точки зрения информационных технологий, жизненного цикла изделий и~организации производства.
\begin{figure}[h!]
    \centering
    \includegraphics[width=.9\textwidth]{rami.jpg}
    \caption[Архитектурная модель RAMI 4.0]
            {Архитектурная модель RAMI 4.0}
    \label{fig:rami}
\end{figure} 

Одна из основных задач данной модели -- обеспечить простое, наглядное и~структурированное представление, которое бы помогало при создании описания компонентов и~локализировало бы их~роль в~предметной области.

Таким образом, для того чтобы обосновать применение структурно-модульного подхода к~реализации графических интерфейсов, далее будет представлено отображение на~архитектурную модель RAMI 4.0 модуля пользовательского графического интерфейса, разработанного с~использованием вышеуказанного подхода.

Модуль графического интерфейса входит в~состав системы управления технологическим оборудованием, поэтому на~правой горизонтальной оси он находится в~областях \textit{<<устройство управления>> и~<<станция>>}. Модуль не входит в область <<полевые устройства>>, поскольку не~имеет связи с~ними напрямую.

Наибольший интерес в~данном случае представляет вертикальная ось. Модуль графического интерфейса находится на~уровнях \textit{<<интеграция>>, <<взаимодействие>>, <<информация>> и <<функционал>>}. Вместе с~этим, он~обеспечивает открытые связи с~вышестоящим и~нижестоящим уровнем. 

\textbf{\textit{Уровень интеграции.}} Цель данного уровня~--~преобразование событий реального мира в~события виртуального мира. На~этом уровне рассматриваемый модуль обеспечивает преобразование действий пользователя (нажатие на~кнопки, ввод программы и~т.д.)~в~события в~виртуальном мире. При этом пользователь находится на нижестоящем уровне~--~уровне активов. Фактически, этим занимается клиентская часть рассматриваемого модуля~--~т.е.~браузер и~JavaScript обработчики событий, активирующиеся при взаимодействии пользователя с~графическими формами.

С~другой стороны, модуль графического интерфейса входит в распределенную гетерогенную сеть системы управления технологическим оборудованием. Поэтому преобразование происходит и~в~обратную сторону. Например, сигнал окончания обработки передается на~модуль графического интерфейса, а тот в~свою очередь извещает об~этом пользователя.

\textbf{\textit{Уровень взаимодействия.}} Целью уровня взаимодействия является определение способа коммуникации, т.е.~интерфейса соединения, протокола и~формата данных, а~также обеспечение связи уровня интеграции и~информационного уровня. Рассматриваемый модуль имеет несколько интерфейсов соединения~--~беспроводное WiFi соединение, Ethernet и~последовательное соединение через UART. В качестве протокола используются очереди сообщений, реализованные с помощью библиотеки \textit{nanomsg}. Очереди построены поверх разных протоколов, например, со~стороны клиента поверх протокола websocket. В~качестве формата передаваемых данных используется бинарный формат \textit{cbor}.

\textbf{\textit{Уровень информации.}} На данном уровне определяются данные, с которыми работает система, способы их хранения, описание событий и их предварительная обработка. В модуле графического интерфейса на этапе инициализации в качестве данных выступают статические файлы, которые передаются от других модулей системы управления. К статическим файлам относятся:
\begin{itemize}
\item html файлы, описывающие структуру графического интерфейса;
\item css файлы, описывающие внешний вид графического интерфейса;
\item js файлы, описывающие логику работы графического интерфейса.
\end{itemize}

Для хранения данных модуль графического интерфейса использует базу данных UnQLite~\cite{unqlite}. Данная система является NoSQL\footnote{NoSQL -- подход к реализации хранилищ данных, где доступ к данным осуществляется без использования языка SQL.} базой данных, основная особенность которой~--~отсутствие сервера. В~отличие от~таких известных NoSql движков как MongoDB\footnote{MongoDB -- документо-ориентированная СУБД, использующая документы, основанные на~формате JSON.}, Redis\footnote{Redis -- сетевое хранилище типа <<ключ-значение>>, осуществляющее хранение в оперативной памяти.}, CouchDB\footnote{ CouchDB -- документо-ориентированная СУБД, написанная на Erlang.}, UnQLite не~требует установки или настройки, а~также не~запускает отдельного процесса для доступа к данным.  Все данные хранятся в~виде одного файла с~сериализованными по~стандарту JSON данными. В~остальном, UnQLite является хранилищем пар <<ключ-значение>>, с~поддержкой курсоров и~возможностью хранить данные как на~диске, так и~в~оперативной памяти. В~дополнение к~этому, UnQLite может работать и~как хранилище документов и~поддерживает транзакции. 

После этапа инициализации модуль работает с данными, вводимыми пользователями, например  G-код программами,  Gerber файлами и т.д.

\textbf{\textit{Уровень функционала.}} На данном уровне определяется перечень функций, которые предлагаются для использования из вне, и платформа для их предоставления. 

Фактически, сам по себе модуль графического интерфейса не обладает функционалом, доступным для других участников, за исключением удаленного доступа. Однако данный модуль является платформой, которую используют участники гетерогенной сети системы управления технологическим оборудованием для того, чтобы предоставить возможность воспользоваться своими функциями. 

\section{Выводы к второй главе}